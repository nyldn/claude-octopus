# Claude Octopus - Multi-Agent Orchestration for CI/CD
# This workflow runs Claude Octopus in CI mode for automated code review and development
#
# Required secrets:
#   OPENAI_API_KEY - Your OpenAI API key for Codex CLI
#   GEMINI_API_KEY - Your Google AI key for Gemini CLI
#
# Optional secrets:
#   ANTHROPIC_API_KEY - For Claude API integration

name: Claude Octopus

on:
  # Manual trigger with custom prompt
  workflow_dispatch:
    inputs:
      command:
        description: 'Command to run (auto, embrace, research, develop, deliver)'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - embrace
          - research
          - develop
          - deliver
          - review
      prompt:
        description: 'Prompt for the AI agents'
        required: true
        type: string
      tier:
        description: 'Model tier (quick, standard, premium)'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - premium

  # PR review and issue comments require OPENAI_API_KEY + GEMINI_API_KEY secrets.
  # Disabled by default - uncomment when secrets are configured.
  #
  # pull_request:
  #   types: [opened, synchronize, reopened]
  #
  # issue_comment:
  #   types: [created]

jobs:
  # Job for manual workflow dispatch
  manual-run:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Codex CLI
        run: npm install -g @openai/codex-cli 2>/dev/null || echo "::warning::Codex CLI not available on npm - install manually"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Install Gemini CLI
        run: npm install -g @anthropic-ai/gemini-cli 2>/dev/null || echo "::warning::Gemini CLI not available on npm - install manually"
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Run Claude Octopus
        id: octopus
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CI: true
          GITHUB_OUTPUT: ${{ github.output }}
          # SECURITY: Pass inputs via env vars to prevent shell injection
          OCTOPUS_COMMAND: ${{ inputs.command }}
          OCTOPUS_PROMPT: ${{ inputs.prompt }}
          OCTOPUS_TIER: ${{ inputs.tier }}
        run: |
          chmod +x ./scripts/orchestrate.sh

          TIER_FLAG=""
          case "$OCTOPUS_TIER" in
            quick) TIER_FLAG="-Q" ;;
            premium) TIER_FLAG="-P" ;;
          esac

          # SECURITY: Validate command against allowlist
          case "$OCTOPUS_COMMAND" in
            auto|embrace|research|develop|deliver|review)
              ./scripts/orchestrate.sh --ci $TIER_FLAG "$OCTOPUS_COMMAND" "$OCTOPUS_PROMPT"
              ;;
            *)
              echo "::error::Invalid command: $OCTOPUS_COMMAND"
              exit 1
              ;;
          esac

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: octopus-results
          path: ~/.claude-octopus/results/
          if-no-files-found: ignore

  # Job for PR code review
  pr-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CLIs
        run: |
          npm install -g @openai/codex-cli 2>/dev/null || echo "::warning::Codex CLI not available on npm - install manually"
          npm install -g @anthropic-ai/gemini-cli 2>/dev/null || echo "::warning::Gemini CLI not available on npm - install manually"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Get Changed Files
        id: changed
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Run Code Review
        id: review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CI: true
          # SECURITY: Pass file list via env var to prevent shell injection
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: |
          chmod +x ./scripts/orchestrate.sh

          # SECURITY: Sanitize file list - remove special characters except safe ones
          SAFE_FILES=$(echo "$CHANGED_FILES" | tr -cd 'a-zA-Z0-9_./ \n-' | head -c 10000)

          REVIEW_PROMPT="Review the following code changes for quality, security, and best practices: $SAFE_FILES"

          ./scripts/orchestrate.sh --ci deliver "$REVIEW_PROMPT" 2>&1 | tee review-output.txt

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('review-output.txt', 'utf8');

            const body = `## Claude Octopus Code Review

            ${output.slice(0, 60000)}

            ---
            *Reviewed by Claude Octopus Multi-Agent System*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Job for issue comment commands
  comment-command:
    if: github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/octopus')
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CLIs
        run: |
          npm install -g @openai/codex-cli 2>/dev/null || echo "::warning::Codex CLI not available on npm - install manually"
          npm install -g @anthropic-ai/gemini-cli 2>/dev/null || echo "::warning::Gemini CLI not available on npm - install manually"
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Parse Command
        id: parse
        env:
          # SECURITY: Pass comment body via env var to prevent shell injection
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Extract command after /octopus
          RAW_PROMPT="${COMMENT_BODY#/octopus }"

          # SECURITY: Sanitize - remove dangerous shell metacharacters
          SAFE_PROMPT=$(echo "$RAW_PROMPT" | tr -cd 'a-zA-Z0-9 _.,:;!?@#%^&*()+=[]{}|<>/-' | head -c 5000)

          # SECURITY: Check for potential command injection patterns
          if echo "$SAFE_PROMPT" | grep -qE '\$\(|`|;[[:space:]]*[a-z]|&&[[:space:]]*[a-z]|\|[[:space:]]*[a-z]'; then
            echo "::error::Potential command injection detected in comment"
            exit 1
          fi

          echo "prompt=$SAFE_PROMPT" >> $GITHUB_OUTPUT

      - name: Run Claude Octopus
        id: octopus
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CI: true
          # SECURITY: Pass prompt via env var
          OCTOPUS_PROMPT: ${{ steps.parse.outputs.prompt }}
        run: |
          chmod +x ./scripts/orchestrate.sh
          ./scripts/orchestrate.sh --ci auto "$OCTOPUS_PROMPT" 2>&1 | tee octopus-output.txt

      - name: Reply to Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('octopus-output.txt', 'utf8');

            const body = `## Claude Octopus Response

            ${output.slice(0, 60000)}

            ---
            *Generated by Claude Octopus Multi-Agent System*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
